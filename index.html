<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ghost</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

:root{
  --bg:#0b0d14;
  --surface:#151821;
  --surface-hover:#1e212b;
  --border:#2a2e3a;
  --text:#e8eaf0;
  --text-secondary:#8b92a8;
  --accent:#60a5fa;
  --accent-hover:#3b82f6;
  --success:#34d399;
  --font:'Inter',system-ui,sans-serif
}

*{margin:0;padding:0;box-sizing:border-box}

html,body{
  height:100vh;
  overflow:hidden;
  font-family:var(--font);
  background:var(--bg);
  color:var(--text)
}

/* Animated space background */
body::before{
  content:'';
  position:fixed;
  inset:0;
  background:
    radial-gradient(ellipse at 20% 80%,rgba(96,165,250,0.15) 0%,transparent 50%),
    radial-gradient(ellipse at 80% 20%,rgba(52,211,153,0.1) 0%,transparent 50%),
    radial-gradient(ellipse at 40% 40%,rgba(139,92,246,0.08) 0%,transparent 40%);
  z-index:-2
}

/* Stars */
body::after{
  content:'';
  position:fixed;
  inset:0;
  background-image:
    radial-gradient(1px 1px at 10% 10%,rgba(255,255,255,0.8),transparent),
    radial-gradient(1px 1px at 20% 80%,rgba(255,255,255,0.6),transparent),
    radial-gradient(1px 1px at 50% 50%,rgba(255,255,255,0.7),transparent),
    radial-gradient(1px 1px at 70% 30%,rgba(255,255,255,0.5),transparent),
    radial-gradient(1.5px 1.5px at 90% 70%,rgba(255,255,255,0.9),transparent),
    radial-gradient(1px 1px at 30% 60%,rgba(255,255,255,0.4),transparent),
    radial-gradient(1px 1px at 60% 90%,rgba(255,255,255,0.6),transparent),
    radial-gradient(1px 1px at 80% 15%,rgba(255,255,255,0.5),transparent);
  background-size:200px 200px;
  animation:twinkle 8s ease-in-out infinite;
  z-index:-1
}

@keyframes twinkle{
  0%,100%{opacity:0.5}
  50%{opacity:1}
}

/* Layout */
.center{
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  padding:24px
}

.card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:20px;
  padding:48px;
  max-width:420px;
  width:100%;
  text-align:center;
  box-shadow:0 25px 50px -12px rgba(0,0,0,0.5),0 0 0 1px rgba(255,255,255,0.05)
}

.logo{
  width:56px;
  height:56px;
  background:linear-gradient(135deg,var(--accent),var(--success));
  border-radius:16px;
  margin:0 auto 24px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:28px;
  box-shadow:0 8px 32px rgba(96,165,250,0.3)
}

h1{
  font-size:32px;
  font-weight:600;
  margin-bottom:8px;
  letter-spacing:-0.5px
}

.subtitle{
  color:var(--text-secondary);
  font-size:15px;
  margin-bottom:32px;
  line-height:1.5
}

/* Inputs */
input,textarea{
  width:100%;
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px 16px;
  color:var(--text);
  font-size:15px;
  font-family:inherit;
  outline:none;
  transition:all 0.2s;
  margin:8px 0
}

input:focus,textarea:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(96,165,250,0.1)
}

input::placeholder,textarea::placeholder{
  color:var(--text-secondary)
}

/* Buttons */
.btn{
  width:100%;
  padding:14px 24px;
  border-radius:12px;
  border:none;
  font-size:15px;
  font-weight:500;
  font-family:inherit;
  cursor:pointer;
  transition:all 0.2s;
  margin-top:12px
}

.btn-primary{
  background:var(--accent);
  color:#0b0d14
}

.btn-primary:hover{
  background:var(--accent-hover);
  transform:translateY(-1px);
  box-shadow:0 8px 24px rgba(96,165,250,0.35)
}

.btn-secondary{
  background:transparent;
  color:var(--text);
  border:1px solid var(--border)
}

.btn-secondary:hover{
  background:var(--surface-hover);
  border-color:var(--text-secondary)
}

/* Code display */
.code-box{
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  font-family:'SF Mono',monospace;
  font-size:12px;
  word-break:break-all;
  margin:16px 0;
  color:var(--text-secondary);
  max-height:120px;
  overflow-y:auto
}

.qr-wrap{
  background:#fff;
  border-radius:16px;
  padding:20px;
  display:inline-block;
  margin:16px 0;
  box-shadow:0 8px 32px rgba(0,0,0,0.3)
}

.status{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  color:var(--text-secondary);
  font-size:13px;
  margin-top:16px
}

.dot{
  width:8px;
  height:8px;
  border-radius:50%;
  background:var(--success);
  animation:pulse 2s infinite
}

@keyframes pulse{
  0%,100%{opacity:1}
  50%{opacity:0.5}
}

/* Chat UI */
#chat-container{
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column
}

#messages{
  flex:1;
  overflow-y:auto;
  padding:24px;
  display:flex;
  flex-direction:column;
  gap:12px
}

.message{
  max-width:75%;
  padding:12px 16px;
  border-radius:18px;
  font-size:15px;
  line-height:1.4;
  animation:slideIn 0.3s ease
}

@keyframes slideIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

.message.received{
  align-self:flex-start;
  background:var(--surface);
  border:1px solid var(--border);
  border-bottom-left-radius:4px
}

.message.sent{
  align-self:flex-end;
  background:var(--accent);
  color:#0b0d14;
  border-bottom-right-radius:4px
}

.message .nick{
  font-size:11px;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.5px;
  margin-bottom:4px;
  opacity:0.7
}

#input-area{
  padding:20px 24px;
  background:var(--surface);
  border-top:1px solid var(--border);
  display:flex;
  gap:12px
}

#msg-input{
  flex:1;
  margin:0
}

#send-btn{
  width:auto;
  margin:0;
  padding:14px 28px
}

.hidden{display:none}
</style>
</head>
<body>
<div id="app"></div>
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<script>
const STUN=[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}];
const S={pc:null,dc:null,key:null,room:null,nick:null,myId:crypto.randomUUID()};
const $=id=>document.getElementById(id);
const rnd=(n=4)=>[...crypto.getRandomValues(new Uint8Array(n))].map(b=>b.toString(16).padStart(2,'0')).join('');
const b64url=buf=>btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
const unb64=s=>{s=s.replace(/-/g,'+').replace(/_/g,'/');while(s.length%4)s+='=';return Uint8Array.from(atob(s),c=>c.charCodeAt(0))};

async function genKey(){return crypto.subtle.generateKey({name:'AES-GCM',length:256},true,['encrypt','decrypt'])}
async function expKey(k){return b64url(await crypto.subtle.exportKey('raw',k))}
async function impKey(s){return crypto.subtle.importKey('raw',unb64(s),{name:'AES-GCM'},true,['encrypt','decrypt'])}
async function enc(k,txt){const iv=crypto.getRandomValues(new Uint8Array(12));const ct=new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM',iv},k,new TextEncoder().encode(txt)));const r=new Uint8Array(12+ct.length);r.set(iv);r.set(ct,12);return b64url(r)}
async function dec(k,data){const buf=unb64(data),iv=buf.slice(0,12),ct=buf.slice(12);return new TextDecoder().decode(await crypto.subtle.decrypt({name:'AES-GCM',iv},k,ct))}
async function compress(s){const c=new CompressionStream('deflate');const w=new Blob([s]).stream().pipeThrough(c);return b64url(new Uint8Array(await new Response(w).arrayBuffer()))}
async function decompress(s){const d=new DecompressionStream('deflate');const w=new Blob([unb64(s)]).stream().pipeThrough(d);return new Response(w).text()}

function showHome(){
  $('app').innerHTML=`<div class="center"><div class="card">
    <div class="logo">üëª</div>
    <h1>Ghost</h1>
    <p class="subtitle">Private conversations.<br>No servers. No logs. Just you.</p>
    <input id="nick-in" placeholder="Your name" maxlength="20" value="${localStorage.getItem('ghost-nick')||''}">
    <button class="btn btn-primary" onclick="doCreate()">Start Conversation</button>
    <button class="btn btn-secondary" onclick="showJoin()">Join Conversation</button>
  </div></div>`;
}

async function doCreate(){
  S.nick=$('nick-in').value.trim()||'Ghost'+rnd(2);
  localStorage.setItem('ghost-nick',S.nick);
  S.room=rnd(4);
  S.key=await genKey();
  const keyStr=await expKey(S.key);

  const pc=new RTCPeerConnection({iceServers:STUN});
  const dc=pc.createDataChannel('chat',{ordered:true});
  setupDC(dc);

  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  await new Promise(r=>{if(pc.iceGatheringState==='complete')r();else pc.onicegatheringstatechange=()=>{if(pc.iceGatheringState==='complete')r()};setTimeout(r,3000)});

  const code='G:'+S.room+'.'+keyStr+'.'+await compress(pc.localDescription.sdp);
  S.pc=pc;

  $('app').innerHTML=`<div class="center"><div class="card">
    <div class="logo">üìã</div>
    <h1>Share This</h1>
    <p class="subtitle">Send this code to start the conversation.<br>Any way you like.</p>
    <div class="qr-wrap" id="qr"></div>
    <div class="code-box" id="code"></div>
    <button class="btn btn-primary" onclick="copyCode()">Copy Code</button>
    <button class="btn btn-secondary" onclick="showAnswer()">I've Been Sent a Reply</button>
  </div></div>`;

  $('code').textContent=code;
  if(code.length>200) $('code').textContent=code.slice(0,100)+'...'+code.slice(-50)+'\n('+code.length+' chars)';
  const qr=qrcode(0,'L');qr.addData(code);qr.make();
  $('qr').innerHTML=qr.createSvgTag({cellSize:3,margin:1});
  window.currentCode=code;
}

function copyCode(){navigator.clipboard.writeText(window.currentCode);const btn=document.querySelector('.btn-primary');btn.textContent='Copied!';setTimeout(()=>btn.textContent='Copy Code',2000);}

function showJoin(){
  S.nick=$('nick-in').value.trim()||'Ghost'+rnd(2);
  localStorage.setItem('ghost-nick',S.nick);
  $('app').innerHTML=`<div class="center"><div class="card">
    <div class="logo">üîë</div>
    <h1>Enter Code</h1>
    <p class="subtitle">Paste the code you received to join.</p>
    <textarea id="code-in" rows="3" placeholder="G:..."></textarea>
    <button class="btn btn-primary" onclick="doJoin()">Connect</button>
    <button class="btn btn-secondary" onclick="showHome()">Back</button>
  </div></div>`;
  $('code-in').focus();
}

async function doJoin(){
  const input=$('code-in').value.trim();
  if(!input.startsWith('G:')){alert('Invalid code');return}
  const parts=input.slice(2).split('.');
  if(parts.length!==3){alert('Invalid code');return}

  S.room=parts[0];
  S.key=await impKey(parts[1]);
  const offerSDP=await decompress(parts[2]);

  const pc=new RTCPeerConnection({iceServers:STUN});
  let dcResolve;
  const dcPromise=new Promise(r=>dcResolve=r);
  pc.ondatachannel=e=>dcResolve(e.channel);

  await pc.setRemoteDescription({type:'offer',sdp:offerSDP});
  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await new Promise(r=>{if(pc.iceGatheringState==='complete')r();else pc.onicegatheringstatechange=()=>{if(pc.iceGatheringState==='complete')r()};setTimeout(r,3000)});

  S.pc=pc;
  const answerCode='A:'+await compress(pc.localDescription.sdp);

  $('app').innerHTML=`<div class="center"><div class="card">
    <div class="logo">‚úâÔ∏è</div>
    <h1>Send This Back</h1>
    <p class="subtitle">They need this to complete the connection.</p>
    <div class="qr-wrap" id="qr"></div>
    <div class="code-box" id="code"></div>
    <button class="btn btn-primary" onclick="copyCode()">Copy Code</button>
  </div></div>`;

  $('code').textContent=answerCode;
  window.currentCode=answerCode;
  const qr=qrcode(0,'L');qr.addData(answerCode);qr.make();
  $('qr').innerHTML=qr.createSvgTag({cellSize:3,margin:1});

  const dc=await dcPromise;
  setupDC(dc);
}

function showAnswer(){
  $('app').innerHTML=`<div class="center"><div class="card">
    <div class="logo">üîì</div>
    <h1>Enter Reply</h1>
    <p class="subtitle">Paste the code they sent back.</p>
    <textarea id="ans-in" rows="3" placeholder="A:..."></textarea>
    <button class="btn btn-primary" onclick="acceptAnswer()">Unlock</button>
  </div></div>`;
}

async function acceptAnswer(){
  const input=$('ans-in').value.trim();
  if(!input.startsWith('A:')){alert('Invalid code');return}
  const answerSDP=await decompress(input.slice(2));
  await S.pc.setRemoteDescription({type:'answer',sdp:answerSDP});
}

function setupDC(dc){
  S.dc=dc;
  dc.onopen=()=>showChat();
  dc.onmessage=async e=>{
    const msg=JSON.parse(await dec(S.key,e.data));
    addMsg(msg.nick,msg.text,false);
  };
}

function showChat(){
  $('app').innerHTML=`<div id="chat-container">
    <div id="messages"></div>
    <div id="input-area">
      <input id="msg-input" placeholder="Type a message..." autocomplete="off">
      <button class="btn btn-primary" id="send-btn" onclick="sendMsg()">Send</button>
    </div>
  </div>`;
  const input=$('msg-input');
  input.onkeypress=e=>{if(e.key==='Enter')sendMsg()};
  input.focus();
  addMsg('Ghost','Connected. This conversation is private and ephemeral.',false);
}

async function sendMsg(){
  const input=$('msg-input');
  const btn=$('send-btn');
  const text=input.value.trim();
  if(!text)return;
  if(!S.dc||S.dc.readyState!=='open'){alert('Not connected');return;}
  input.value='';
  btn.disabled=true;
  try{
    const msg={nick:S.nick,text,time:Date.now()};
    S.dc.send(await enc(S.key,JSON.stringify(msg)));
    addMsg(S.nick,text,true);
  }catch(e){console.error(e);}
  finally{btn.disabled=false;input.focus();}
}

function addMsg(nick,text,self){
  const div=document.createElement('div');
  div.className='message '+(self?'sent':'received');
  div.innerHTML=`<div class="nick">${nick}</div><div>${text}</div>`;
  const msgs=document.getElementById('messages');
  if(!msgs)return;
  msgs.appendChild(div);
  msgs.scrollTop=msgs.scrollHeight;
}

showHome();
</script>
</body>
</html>
