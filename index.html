<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ghost</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

:root{
  --bg:#0b0d14;
  --surface:#151821;
  --surface-hover:#1e212b;
  --border:#2a2e3a;
  --text:#e8eaf0;
  --text-secondary:#8b92a8;
  --accent:#60a5fa;
  --accent-hover:#3b82f6;
  --success:#34d399;
  --warning:#fbbf24;
  --danger:#f87171;
  --font:'Inter',system-ui,sans-serif
}

*{margin:0;padding:0;box-sizing:border-box}

html,body{
  height:100vh;
  overflow:hidden;
  font-family:var(--font);
  background:var(--bg);
  color:var(--text)
}

body::before{
  content:'';
  position:fixed;
  inset:0;
  background:
    radial-gradient(ellipse at 20% 80%,rgba(96,165,250,0.15) 0%,transparent 50%),
    radial-gradient(ellipse at 80% 20%,rgba(52,211,153,0.1) 0%,transparent 50%),
    radial-gradient(ellipse at 40% 40%,rgba(139,92,246,0.08) 0%,transparent 40%);
  z-index:-2
}

body::after{
  content:'';
  position:fixed;
  inset:0;
  background-image:
    radial-gradient(1px 1px at 10% 10%,rgba(255,255,255,0.8),transparent),
    radial-gradient(1px 1px at 20% 80%,rgba(255,255,255,0.6),transparent),
    radial-gradient(1px 1px at 50% 50%,rgba(255,255,255,0.7),transparent),
    radial-gradient(1px 1px at 70% 30%,rgba(255,255,255,0.5),transparent),
    radial-gradient(1.5px 1.5px at 90% 70%,rgba(255,255,255,0.9),transparent),
    radial-gradient(1px 1px at 30% 60%,rgba(255,255,255,0.4),transparent),
    radial-gradient(1px 1px at 60% 90%,rgba(255,255,255,0.6),transparent),
    radial-gradient(1px 1px at 80% 15%,rgba(255,255,255,0.5),transparent);
  background-size:200px 200px;
  animation:twinkle 8s ease-in-out infinite;
  z-index:-1
}

@keyframes twinkle{0%,100%{opacity:0.5}50%{opacity:1}}

.center{
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  padding:24px
}

.card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:20px;
  padding:48px;
  max-width:480px;
  width:100%;
  text-align:center;
  box-shadow:0 25px 50px -12px rgba(0,0,0,0.5),0 0 0 1px rgba(255,255,255,0.05)
}

.logo{
  width:56px;
  height:56px;
  background:linear-gradient(135deg,var(--accent),var(--success));
  border-radius:16px;
  margin:0 auto 24px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:28px;
  box-shadow:0 8px 32px rgba(96,165,250,0.3)
}

.logo.admin{
  background:linear-gradient(135deg,var(--warning),var(--danger));
  box-shadow:0 8px 32px rgba(251,191,36,0.3)
}

h1{font-size:32px;font-weight:600;margin-bottom:8px;letter-spacing:-0.5px}
.subtitle{color:var(--text-secondary);font-size:15px;margin-bottom:32px;line-height:1.5}

input,textarea,select{
  width:100%;
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px 16px;
  color:var(--text);
  font-size:15px;
  font-family:inherit;
  outline:none;
  transition:all 0.2s;
  margin:8px 0
}

input:focus,textarea:focus,select:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(96,165,250,0.1)
}

input::placeholder,textarea::placeholder{color:var(--text-secondary)}

.btn{
  width:100%;
  padding:14px 24px;
  border-radius:12px;
  border:none;
  font-size:15px;
  font-weight:500;
  font-family:inherit;
  cursor:pointer;
  transition:all 0.2s;
  margin-top:12px
}

.btn-primary{
  background:var(--accent);
  color:#0b0d14
}

.btn-primary:hover{
  background:var(--accent-hover);
  transform:translateY(-1px);
  box-shadow:0 8px 24px rgba(96,165,250,0.35)
}

.btn-secondary{
  background:transparent;
  color:var(--text);
  border:1px solid var(--border)
}

.btn-secondary:hover{background:var(--surface-hover);border-color:var(--text-secondary)}

.btn-danger{
  background:var(--danger);
  color:#0b0d14
}

.btn-danger:hover{
  background:#ef4444;
  transform:translateY(-1px);
  box-shadow:0 8px 24px rgba(248,113,113,0.35)
}

.btn-small{
  width:auto;
  padding:8px 16px;
  font-size:13px;
  margin-top:0
}

.code-box{
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  font-family:'SF Mono',monospace;
  font-size:12px;
  word-break:break-all;
  margin:16px 0;
  color:var(--text-secondary);
  max-height:120px;
  overflow-y:auto;
  text-align:left
}

.qr-wrap{
  background:#fff;
  border-radius:16px;
  padding:20px;
  display:inline-block;
  margin:16px 0;
  box-shadow:0 8px 32px rgba(0,0,0,0.3);
  text-decoration:none;
  cursor:pointer
}

.qr-wrap:hover{
  transform:scale(1.02);
  box-shadow:0 12px 40px rgba(0,0,0,0.4)
}

a.code-box{
  display:block;
  color:var(--accent);
  text-decoration:none;
  cursor:pointer
}

a.code-box:hover{
  border-color:var(--accent)
}

/* Chat UI */
#chat-container{
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column
}

#chat-header{
  padding:16px 24px;
  background:var(--surface);
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center
}

#chat-header h2{
  font-size:16px;
  font-weight:600;
  display:flex;
  align-items:center;
  gap:8px
}

#chat-header .badge{
  font-size:11px;
  padding:4px 8px;
  border-radius:6px;
  background:var(--border);
  color:var(--text-secondary);
  font-weight:500
}

#chat-header .badge.admin{
  background:var(--warning);
  color:#0b0d14
}

#header-actions{
  display:flex;
  gap:8px
}

#messages{
  flex:1;
  overflow-y:auto;
  padding:24px;
  display:flex;
  flex-direction:column;
  gap:12px
}

#messages.drag-over{
  background:rgba(96,165,250,0.1);
  outline:2px dashed var(--accent);
  outline-offset:-12px
}

.message{
  max-width:75%;
  padding:12px 16px;
  border-radius:18px;
  font-size:15px;
  line-height:1.4;
  animation:slideIn 0.3s ease;
  position:relative
}

@keyframes slideIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

.message.received{
  align-self:flex-start;
  background:var(--surface);
  border:1px solid var(--border);
  border-bottom-left-radius:4px
}

.message.sent{
  align-self:flex-end;
  background:var(--accent);
  color:#0b0d14;
  border-bottom-right-radius:4px
}

.message .nick{
  font-size:11px;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.5px;
  margin-bottom:4px;
  opacity:0.7
}

.message .meta{
  font-size:11px;
  opacity:0.5;
  margin-top:4px;
  display:flex;
  gap:8px;
  align-items:center
}

.message .file-attachment{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  background:rgba(0,0,0,0.2);
  border-radius:8px;
  margin-top:8px;
  cursor:pointer;
  transition:all 0.2s
}

.message .file-attachment:hover{
  background:rgba(0,0,0,0.3)
}

.message.selected{
  outline:2px solid var(--accent);
  outline-offset:2px
}

#input-area{
  padding:16px 24px;
  background:var(--surface);
  border-top:1px solid var(--border);
  display:flex;
  flex-direction:column;
  gap:12px
}

#input-row{
  display:flex;
  gap:12px;
  align-items:center
}

#msg-input{
  flex:1;
  margin:0
}

#send-btn, #file-btn{
  width:auto;
  margin:0;
  padding:14px 20px
}

#file-btn{
  background:transparent;
  border:1px solid var(--border);
  color:var(--text);
  font-size:20px;
  line-height:1;
  padding:12px 16px
}

#file-btn:hover{background:var(--surface-hover)}

#selection-bar{
  display:none;
  justify-content:space-between;
  align-items:center;
  padding:12px 16px;
  background:var(--bg);
  border-radius:8px;
  margin-bottom:8px
}

#selection-bar.active{display:flex}

#selection-info{
  font-size:14px;
  color:var(--text-secondary)
}

#selection-actions{
  display:flex;
  gap:8px
}

#drop-overlay{
  position:fixed;
  inset:0;
  background:rgba(11,13,20,0.9);
  display:none;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:100;
  backdrop-filter:blur(4px)
}

#drop-overlay.active{display:flex}

#drop-overlay .drop-icon{
  font-size:64px;
  margin-bottom:24px
}

#drop-overlay p{
  font-size:20px;
  color:var(--text-secondary)
}

/* Settings panel */
#settings-panel{
  position:fixed;
  top:0;
  right:-400px;
  width:400px;
  height:100vh;
  background:var(--surface);
  border-left:1px solid var(--border);
  padding:24px;
  overflow-y:auto;
  transition:right 0.3s ease;
  z-index:50
}

#settings-panel.open{right:0}

#settings-panel h3{
  font-size:18px;
  margin-bottom:24px;
  display:flex;
  justify-content:space-between;
  align-items:center
}

#settings-panel .close-btn{
  background:none;
  border:none;
  color:var(--text-secondary);
  font-size:24px;
  cursor:pointer
}

#settings-panel .section{
  margin-bottom:32px;
  padding-bottom:32px;
  border-bottom:1px solid var(--border)
}

#settings-panel .section:last-child{border:none}

#settings-panel h4{
  font-size:14px;
  text-transform:uppercase;
  letter-spacing:0.5px;
  color:var(--text-secondary);
  margin-bottom:16px
}

.setting-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px
}

.setting-row label{font-size:14px}

/* Toggle switch */
.toggle{
  width:44px;
  height:24px;
  background:var(--border);
  border-radius:12px;
  position:relative;
  cursor:pointer;
  transition:background 0.2s
}

.toggle.active{background:var(--accent)}

.toggle::after{
  content:'';
  position:absolute;
  width:20px;
  height:20px;
  background:var(--text);
  border-radius:50%;
  top:2px;
  left:2px;
  transition:transform 0.2s
}

.toggle.active::after{transform:translateX(20px)}

/* Member list */
.member-list{
  display:flex;
  flex-direction:column;
  gap:8px
}

.member{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px;
  background:var(--bg);
  border-radius:8px
}

.member .avatar{
  width:32px;
  height:32px;
  border-radius:50%;
  background:var(--accent);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  font-weight:600
}

.member .info{flex:1}

.member .name{
  font-size:14px;
  font-weight:500
}

.member .role{
  font-size:12px;
  color:var(--text-secondary)
}

/* Modal */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:100;
  backdrop-filter:blur(4px)
}

.modal-overlay.active{display:flex}

.modal{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:16px;
  padding:32px;
  max-width:420px;
  width:90%;
  max-height:80vh;
  overflow-y:auto
}

.modal h3{
  font-size:20px;
  margin-bottom:16px
}

.modal p{
  color:var(--text-secondary);
  margin-bottom:24px;
  line-height:1.5
}

.modal .btn-group{
  display:flex;
  gap:12px
}

.modal .btn-group .btn{flex:1;margin-top:0}

.hidden{display:none}
</style>
</head>
<body>
<div id="app"></div>
<div id="drop-overlay">
  <div class="drop-icon">üìÅ</div>
  <p>Drop files to send</p>
</div>
<div id="settings-panel">
  <h3>Settings <button class="close-btn" onclick="toggleSettings()">&times;</button></h3>
  <div id="settings-content"></div>
</div>
<div id="modal-overlay" class="modal-overlay">
  <div class="modal" id="modal-content"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<script>
// ============== CRYPTO UTILS ==============
const b64url=buf=>btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
const unb64=s=>{s=s.replace(/-/g,'+').replace(/_/g,'/');while(s.length%4)s+='=';return Uint8Array.from(atob(s),c=>c.charCodeAt(0))};
const rnd=(n=4)=>[...crypto.getRandomValues(new Uint8Array(n))].map(b=>b.toString(16).padStart(2,'0')).join('');

async function genAESKey(){return crypto.subtle.generateKey({name:'AES-GCM',length:256},true,['encrypt','decrypt'])}
async function expAESKey(k){return b64url(await crypto.subtle.exportKey('raw',k))}
async function impAESKey(s){return crypto.subtle.importKey('raw',unb64(s),{name:'AES-GCM'},true,['encrypt','decrypt'])}
async function aesEnc(k,txt){const iv=crypto.getRandomValues(new Uint8Array(12));const ct=new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM',iv},k,new TextEncoder().encode(txt)));const r=new Uint8Array(12+ct.length);r.set(iv);r.set(ct,12);return b64url(r)}
async function aesDec(k,data){const buf=unb64(data),iv=buf.slice(0,12),ct=buf.slice(12);return new TextDecoder().decode(await crypto.subtle.decrypt({name:'AES-GCM',iv},k,ct))}

async function genECDSAKey(){return crypto.subtle.generateKey({name:'ECDSA',namedCurve:'P-256'},true,['sign','verify'])}
async function expECDSAPub(k){return b64url(await crypto.subtle.exportKey('spki',k))}
async function impECDSAPub(s){return crypto.subtle.importKey('spki',unb64(s),{name:'ECDSA',namedCurve:'P-256'},true,['verify'])}
async function signData(privKey,data){const sig=await crypto.subtle.sign({name:'ECDSA',hash:'SHA-256'},privKey,new TextEncoder().encode(data));return b64url(sig)}
async function verifyData(pubKey,data,sig){return crypto.subtle.verify({name:'ECDSA',hash:'SHA-256'},pubKey,unb64(sig),new TextEncoder().encode(data))}

async function compress(s){const c=new CompressionStream('deflate');const w=new Blob([s]).stream().pipeThrough(c);return b64url(new Uint8Array(await new Response(w).arrayBuffer()))}
async function decompress(s){const d=new DecompressionStream('deflate');const w=new Blob([unb64(s)]).stream().pipeThrough(d);return new Response(w).text()}

// ============== STATE ==============
const STUN=[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}];
const $=id=>document.getElementById(id);

const S={
  pc:null,
  dc:null,
  roomKey:null,
  roomId:null,
  nick:null,
  myId:crypto.randomUUID(),
  myKeyPair:null,
  myPubKey:null,
  adminPubKey:null,
  isAdmin:false,
  peers:new Map(),
  messages:[],
  selectedMessages:new Set(),
  files:new Map(),
  msgTTL:4*60*60*1000,
  maxPeers:10,
  expiresAt:null
};

// ============== STORAGE ==============
const Storage={
  get(k){try{return JSON.parse(localStorage.getItem('ghost:'+k))}catch(e){return null}},
  set(k,v){localStorage.setItem('ghost:'+k,JSON.stringify(v))},
  del(k){localStorage.removeItem('ghost:'+k)},
  clear(){for(let k of Object.keys(localStorage))if(k.startsWith('ghost:'))localStorage.removeItem(k)}
};

// ============== UI HELPERS ==============
function showHome(){
  const saved=Storage.get('session');
  $('app').innerHTML=`<div class="center"><div class="card">
    <div class="logo">üëª</div>
    <h1>Ghost</h1>
    <p class="subtitle">Private group chats.<br>No servers. No logs. Just encrypted.</p>
    <input id="nick-in" placeholder="Your name" maxlength="20" value="${Storage.get('nick')||''}">
    <button class="btn btn-primary" onclick="doCreate()">Create Room (Admin)</button>
    <button class="btn btn-secondary" onclick="showJoin()">Join Room</button>
    ${saved?`<button class="btn btn-secondary" onclick="restoreSession()">Rejoin Last Room</button>`:''}
  </div></div>`;
}

async function doCreate(){
  S.nick=$('nick-in').value.trim()||'Ghost'+rnd(2);
  Storage.set('nick',S.nick);
  S.roomId=rnd(8);
  S.roomKey=await genAESKey();
  S.isAdmin=true;
  S.myKeyPair=await genECDSAKey();
  S.myPubKey=await expECDSAPub(S.myKeyPair.publicKey);
  S.adminPubKey=S.myPubKey;
  S.expiresAt=Date.now()+24*60*60*1000;

  const pc=new RTCPeerConnection({iceServers:STUN});
  const dc=pc.createDataChannel('chat',{ordered:true});
  setupDC(dc,true);

  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  await waitICE(pc);

  const roomKeyStr=await expAESKey(S.roomKey);
  const code='G:'+S.roomId+'.'+roomKeyStr+'.'+S.myPubKey+'.'+await compress(pc.localDescription.sdp);
  const baseUrl=location.origin+location.pathname;
  const link=baseUrl+'#'+encodeURIComponent(code);
  S.pc=pc;

  saveSession();

  $('app').innerHTML=`<div class="center"><div class="card">
    <div class="logo admin">üëë</div>
    <h1>Admin Room Created</h1>
    <p class="subtitle">Share this invite link.<br>Expires in 24 hours.</p>
    <a href="${link}" class="qr-wrap" id="qr" title="Click or scan to join"></a>
    <a href="${link}" class="code-box" id="code"></a>
    <button class="btn btn-primary" onclick="copyLink()">Copy Link</button>
    <button class="btn btn-secondary" onclick="showAnswer()">Enter Reply Code</button>
    <button class="btn btn-secondary" onclick="showHome()">Back</button>
  </div></div>`;

  $('code').textContent=link;
  window.currentLink=link;
  window.currentCode=code;
  const qr=qrcode(0,'L');qr.addData(link);qr.make();
  $('qr').innerHTML=qr.createSvgTag({cellSize:3,margin:1});
}

function showJoin(prefillCode){
  S.nick=Storage.get('nick')||'Ghost'+rnd(2);
  Storage.set('nick',S.nick);
  $('app').innerHTML=`<div class="center"><div class="card">
    <div class="logo">üîë</div>
    <h1>Join Room</h1>
    <p class="subtitle">Paste the invite code.</p>
    <textarea id="code-in" rows="4" placeholder="G:..."></textarea>
    <button class="btn btn-primary" onclick="doJoin()">Connect</button>
    <button class="btn btn-secondary" onclick="showHome()">Back</button>
  </div></div>`;
  if(prefillCode){
    $('code-in').value=prefillCode;
    doJoin();
  }else{
    $('code-in').focus();
  }
}

async function doJoin(){
  const input=$('code-in').value.trim();
  if(!input.startsWith('G:')){alert('Invalid code');return}
  const parts=input.slice(2).split('.');
  if(parts.length!==4){alert('Invalid code format');return}

  S.roomId=parts[0];
  S.roomKey=await impAESKey(parts[1]);
  S.adminPubKey=parts[2];
  S.isAdmin=false;
  S.myKeyPair=await genECDSAKey();
  S.myPubKey=await expECDSAPub(S.myKeyPair.publicKey);
  const offerSDP=await decompress(parts[3]);

  const pc=new RTCPeerConnection({iceServers:STUN});
  let dcResolve;
  const dcPromise=new Promise(r=>dcResolve=r);
  pc.ondatachannel=e=>dcResolve(e.channel);

  await pc.setRemoteDescription({type:'offer',sdp:offerSDP});
  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await waitICE(pc);

  S.pc=pc;
  const answerCode='A:'+S.myPubKey+'.'+await compress(pc.localDescription.sdp);
  const baseUrl=location.origin+location.pathname;
  const link=baseUrl+'#A='+encodeURIComponent(answerCode);

  saveSession();

  $('app').innerHTML=`<div class="center"><div class="card">
    <div class="logo">‚úâÔ∏è</div>
    <h1>Send Reply</h1>
    <p class="subtitle">Give this back to the admin.</p>
    <a href="${link}" class="qr-wrap" id="qr" title="Click or scan"></a>
    <a href="${link}" class="code-box" id="code"></a>
    <button class="btn btn-primary" onclick="copyLink()">Copy Link</button>
  </div></div>`;

  $('code').textContent=link;
  window.currentLink=link;
  window.currentCode=answerCode;
  const qr=qrcode(0,'L');qr.addData(link);qr.make();
  $('qr').innerHTML=qr.createSvgTag({cellSize:3,margin:1});

  const dc=await dcPromise;
  setupDC(dc,false);
}

function showAnswer(){
  $('app').innerHTML=`<div class="center"><div class="card">
    <div class="logo">üîì</div>
    <h1>Enter Reply</h1>
    <p class="subtitle">Paste the answer code from peer.</p>
    <textarea id="ans-in" rows="4" placeholder="A:..."></textarea>
    <button class="btn btn-primary" onclick="acceptAnswer()">Connect</button>
  </div></div>`;
}

async function acceptAnswer(){
  const input=$('ans-in').value.trim();
  if(!input.startsWith('A:')){alert('Invalid code');return}
  const parts=input.slice(2).split('.');
  if(parts.length!==2){alert('Invalid code');return}

  const peerPubKey=parts[0];
  const answerSDP=await decompress(parts[1]);
  await S.pc.setRemoteDescription({type:'answer',sdp:answerSDP});

  // Send admin pubkey to new peer
  sendToPeer(peerPubKey,{type:'admin-pubkey',pubKey:S.adminPubKey,from:S.myId});
}

async function waitICE(pc){
  return new Promise(r=>{
    if(pc.iceGatheringState==='complete')r();
    else pc.onicegatheringstatechange=()=>{if(pc.iceGatheringState==='complete')r()};
    setTimeout(r,3000);
  });
}

function copyCode(){navigator.clipboard.writeText(window.currentCode);const btn=document.querySelector('.btn-primary');btn.textContent='Copied!';setTimeout(()=>btn.textContent='Copy Code',2000);}
function copyLink(){navigator.clipboard.writeText(window.currentLink);const btn=document.querySelector('.btn-primary');btn.textContent='Copied!';setTimeout(()=>btn.textContent='Copy Link',2000);}

// ============== CHAT UI ==============
function showChat(){
  $('app').innerHTML=`<div id="chat-container">
    <div id="chat-header">
      <h2>üëª Ghost <span class="badge${S.isAdmin?' admin':''}">${S.isAdmin?'Admin':'Member'}</span></h2>
      <div id="header-actions">
        <button class="btn btn-small btn-secondary" onclick="toggleSettings()">‚öôÔ∏è</button>
        <button class="btn btn-small btn-danger" onclick="leaveRoom()">Leave</button>
      </div>
    </div>
    <div id="messages"></div>
    <div id="input-area">
      <div id="selection-bar">
        <span id="selection-info">0 selected</span>
        <div id="selection-actions">
          <button class="btn btn-small btn-secondary" onclick="copySelected()">Copy</button>
          <button class="btn btn-small btn-secondary" onclick="downloadSelected()">Download</button>
          <button class="btn btn-small" onclick="clearSelection()">Cancel</button>
        </div>
      </div>
      <div id="input-row">
        <button id="file-btn" onclick="selectFile()" title="Send file">üìé</button>
        <input type="file" id="file-input" style="display:none" onchange="handleFileSelect(event)">
        <input id="msg-input" placeholder="Type a message..." autocomplete="off">
        <button class="btn btn-primary" id="send-btn" onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>`;

  const input=$('msg-input');
  input.onkeypress=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg()}};
  input.focus();

  setupDragDrop();
  loadStoredMessages();
  addMsg('Ghost','Connected. Messages expire after 4 hours.',false,'system');
}

function setupDragDrop(){
  const msgs=$('messages');
  const overlay=$('drop-overlay');

  document.body.ondragover=e=>{e.preventDefault();overlay.classList.add('active')};
  document.body.ondragleave=e=>{if(e.target===overlay)overlay.classList.remove('active')};
  document.body.ondrop=e=>{
    e.preventDefault();
    overlay.classList.remove('active');
    if(e.dataTransfer.files.length)handleFiles(e.dataTransfer.files);
  };

  msgs.onclick=e=>{
    const msgEl=e.target.closest('.message');
    if(!msgEl)return;
    if(e.ctrlKey||e.metaKey||e.shiftKey){
      e.preventDefault();
      toggleMessageSelect(msgEl);
    }
  };
}

function setupDC(dc,isAdmin){
  S.dc=dc;
  dc.onopen=()=>showChat();
  dc.onmessage=async e=>{
    try{
      const payload=JSON.parse(await aesDec(S.roomKey,e.data));
      await handleMessage(payload);
    }catch(err){console.error('Decryption failed:',err)}
  };
  dc.onclose=()=>{addMsg('Ghost','Disconnected',false,'system');};
}

async function handleMessage(payload){
  // Verify signature
  if(payload.sig&&payload.fromPubKey){
    const pubKey=await impECDSAPub(payload.fromPubKey);
    const dataStr=JSON.stringify(payload.data);
    const valid=await verifyData(pubKey,dataStr,payload.sig);
    if(!valid){console.error('Invalid signature');return}
  }

  const msg=payload.data;

  switch(msg.type){
    case 'chat':
      addMsg(msg.nick,msg.text,false,msg.from,S.isAdmin&&msg.fromPubKey===S.adminPubKey,msg.ts);
      storeMessage(msg);
      break;
    case 'file':
      handleFileMessage(msg);
      break;
    case 'admin-pubkey':
      if(!S.isAdmin)S.adminPubKey=msg.pubKey;
      break;
    case 'admin-action':
      await handleAdminAction(msg);
      break;
    case 'self-destruct':
      handleSelfDestruct();
      break;
  }
}

async function sendMsg(){
  const input=$('msg-input');
  const text=input.value.trim();
  if(!text)return;
  if(!S.dc||S.dc.readyState!=='open'){alert('Not connected');return}

  input.value='';
  const msg={
    type:'chat',
    from:S.myId,
    nick:S.nick,
    text,
    ts:Date.now()
  };

  const payload=await signPayload(msg);
  S.dc.send(await aesEnc(S.roomKey,JSON.stringify(payload)));
  addMsg(S.nick,text,true,S.myId,false,msg.ts);
  storeMessage({...msg,self:true});
}

async function signPayload(data){
  const dataStr=JSON.stringify(data);
  const sig=await signData(S.myKeyPair.privateKey,dataStr);
  return{data,sig,fromPubKey:S.myPubKey};
}

function addMsg(nick,text,self,fromId,isAdminMsg,ts){
  const div=document.createElement('div');
  div.className='message '+(self?'sent':'received');
  div.dataset.msgId=ts||Date.now();
  div.dataset.from=fromId||'unknown';

  const timeStr=ts?new Date(ts).toLocaleTimeString():new Date().toLocaleTimeString();
  const adminBadge=isAdminMsg?'<span style="color:var(--warning)">üëë</span> ':'';

  div.innerHTML=`<div class="nick">${adminBadge}${nick}</div><div>${escapeHtml(text)}</div><div class="meta">${timeStr}</div>`;

  const msgs=$('messages');
  if(!msgs)return;
  msgs.appendChild(div);
  msgs.scrollTop=msgs.scrollHeight;
}

// ============== FILES ==============
function selectFile(){$('file-input').click()}

async function handleFileSelect(e){
  if(e.target.files.length)await handleFiles(e.target.files);
}

async function handleFiles(files){
  for(const file of files){
    const reader=new FileReader();
    reader.onload=async e=>{
      const data=e.target.result;
      const hash=await hashData(data);
      const fileId=rnd(16);

      const msg={
        type:'file',
        from:S.myId,
        nick:S.nick,
        fileId,
        name:file.name,
        size:file.size,
        mime:file.type,
        hash,
        ts:Date.now()
      };

      S.files.set(fileId,{name:file.name,data,mime:file.type});

      const payload=await signPayload(msg);
      S.dc.send(await aesEnc(S.roomKey,JSON.stringify(payload)));

      addFileMessage(S.nick,file.name,file.size,true,fileId);
    };
    reader.readAsDataURL(file);
  }
}

function addFileMessage(nick,name,size,self,fileId){
  const div=document.createElement('div');
  div.className='message '+(self?'sent':'received');
  div.dataset.fileId=fileId;

  const sizeStr=formatBytes(size);

  div.innerHTML=`<div class="nick">${nick}</div>
    <div class="file-attachment" onclick="downloadFile('${fileId}')">
      <span>üìÑ</span>
      <div>
        <div>${escapeHtml(name)}</div>
        <div style="font-size:12px;opacity:0.7">${sizeStr}</div>
      </div>
    </div>`;

  const msgs=$('messages');
  if(!msgs)return;
  msgs.appendChild(div);
  msgs.scrollTop=msgs.scrollHeight;
}

function handleFileMessage(msg){
  addFileMessage(msg.nick,msg.name,msg.size,false,msg.fileId);
  // Store file metadata, actual data comes via data channel chunks or webrtc data
  // For now, simple approach: files are sent inline via data URL in follow-up message
}

function downloadFile(fileId){
  const file=S.files.get(fileId);
  if(!file)return alert('File not available');

  const a=document.createElement('a');
  a.href=file.data;
  a.download=file.name;
  a.click();
}

async function hashData(data){
  const buf=await fetch(data).then(r=>r.arrayBuffer());
  const hash=await crypto.subtle.digest('SHA-256',buf);
  return b64url(hash);
}

function formatBytes(b){
  if(b<1024)return b+' B';
  if(b<1024*1024)return(b/1024).toFixed(1)+' KB';
  return(b/(1024*1024)).toFixed(1)+' MB';
}

// ============== SELECTION ==============
function toggleMessageSelect(el){
  const id=el.dataset.msgId;
  if(S.selectedMessages.has(id)){
    S.selectedMessages.delete(id);
    el.classList.remove('selected');
  }else{
    S.selectedMessages.add(id);
    el.classList.add('selected');
  }
  updateSelectionBar();
}

function updateSelectionBar(){
  const bar=$('selection-bar');
  const info=$('selection-info');
  if(S.selectedMessages.size>0){
    bar.classList.add('active');
    info.textContent=`${S.selectedMessages.size} selected`;
  }else{
    bar.classList.remove('active');
  }
}

function clearSelection(){
  S.selectedMessages.clear();
  document.querySelectorAll('.message.selected').forEach(el=>el.classList.remove('selected'));
  updateSelectionBar();
}

function copySelected(){
  const texts=[];
  document.querySelectorAll('.message').forEach(el=>{
    if(S.selectedMessages.has(el.dataset.msgId)){
      const nick=el.querySelector('.nick').textContent;
      const text=el.querySelector('div:nth-child(2)').textContent;
      texts.push(`${nick}: ${text}`);
    }
  });
  navigator.clipboard.writeText(texts.join('\n'));
  clearSelection();
}

function downloadSelected(){
  // Download files from selected messages
  document.querySelectorAll('.message').forEach(el=>{
    if(S.selectedMessages.has(el.dataset.msgId)&&el.dataset.fileId){
      downloadFile(el.dataset.fileId);
    }
  });
  clearSelection();
}

// ============== ADMIN ACTIONS ==============
async function handleAdminAction(msg){
  // Verify admin signature
  const adminKey=await impECDSAPub(S.adminPubKey);
  const valid=await verifyData(adminKey,JSON.stringify(msg.action),msg.sig);
  if(!valid){console.error('Invalid admin signature');return}

  switch(msg.action.type){
    case 'kick':
      if(msg.action.target===S.myId){
        alert('You have been removed by admin');
        leaveRoom();
      }
      break;
    case 'self-destruct':
      handleSelfDestruct();
      break;
  }
}

async function sendAdminAction(action){
  if(!S.isAdmin){alert('Only admin can do this');return}
  const sig=await signData(S.myKeyPair.privateKey,JSON.stringify(action));
  const msg={type:'admin-action',action,sig};
  S.dc.send(await aesEnc(S.roomKey,JSON.stringify(msg)));
}

function handleSelfDestruct(){
  Storage.clear();
  S.messages=[];
  S.files.clear();
  document.getElementById('messages').innerHTML='';
  addMsg('Ghost','Room destroyed by admin. All messages deleted.',false,'system');
  setTimeout(()=>{alert('Room destroyed');leaveRoom()},2000);
}

// ============== SETTINGS ==============
function toggleSettings(){
  const panel=$('settings-panel');
  const content=$('settings-content');

  if(panel.classList.contains('open')){
    panel.classList.remove('open');
    return;
  }

  panel.classList.add('open');

  let html=`<div class="section">
    <h4>Room Info</h4>
    <div class="setting-row"><label>Room ID</label><span style="font-family:monospace;font-size:12px">${S.roomId}</span></div>
    <div class="setting-row"><label>Your Role</label><span>${S.isAdmin?'Admin':'Member'}</span></div>
    <div class="setting-row"><label>Peers</label><span>${S.peers.size+1}</span></div>
  </div>`;

  if(S.isAdmin){
    html+=`<div class="section">
      <h4>Admin Actions</h4>
      <button class="btn btn-danger" onclick="confirmSelfDestruct()">Destroy Room</button>
      <button class="btn btn-secondary" style="margin-top:8px" onclick="showInviteCode()">Show Invite Code</button>
    </div>`;
  }

  html+=`<div class="section">
    <h4>Settings</h4>
    <div class="setting-row">
      <label>Message TTL (4h default)</label>
      <div class="toggle" id="ttl-toggle" onclick="toggleTTL()"></div>
    </div>
    <button class="btn btn-secondary" style="margin-top:16px" onclick="exportMessages()">Export Messages</button>
  </div>`;

  content.innerHTML=html;
}

function confirmSelfDestruct(){
  if(!confirm('Destroy room and delete all messages for everyone?'))return;
  sendAdminAction({type:'self-destruct',ts:Date.now()});
  handleSelfDestruct();
}

function showInviteCode(){
  // Regenerate invite code
  alert('Invite code:\n'+window.currentCode);
}

function toggleTTL(){
  const t=$('ttl-toggle');
  t.classList.toggle('active');
}

function exportMessages(){
  const data=Storage.get('messages_'+S.roomId)||[];
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`ghost-${S.roomId}-${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

// ============== STORAGE ==============
function saveSession(){
  Storage.set('session',{
    roomId:S.roomId,
    roomKey:expAESKey(S.roomKey),
    myId:S.myId,
    myPubKey:S.myPubKey,
    adminPubKey:S.adminPubKey,
    isAdmin:S.isAdmin,
    nick:S.nick,
    expiresAt:S.expiresAt
  });
}

async function restoreSession(){
  const sess=Storage.get('session');
  if(!sess){alert('No saved session');return}
  if(sess.expiresAt&&Date.now()>sess.expiresAt){Storage.del('session');alert('Session expired');return}

  S.roomId=sess.roomId;
  S.roomKey=await impAESKey(sess.roomKey);
  S.myId=sess.myId;
  S.myPubKey=sess.myPubKey;
  S.adminPubKey=sess.adminPubKey;
  S.isAdmin=sess.isAdmin;
  S.nick=sess.nick;

  // Need to re-establish connection
  showHome();
  alert('Session restored. Use Join to reconnect with a new answer code.');
}

function storeMessage(msg){
  const key='messages_'+S.roomId;
  const msgs=Storage.get(key)||[];
  msgs.push({...msg,ts:msg.ts||Date.now()});
  // Clean old messages
  const cutoff=Date.now()-S.msgTTL;
  const filtered=msgs.filter(m=>m.ts>cutoff);
  Storage.set(key,filtered);
}

function loadStoredMessages(){
  const key='messages_'+S.roomId;
  const msgs=Storage.get(key)||[];
  const cutoff=Date.now()-S.msgTTL;
  for(const m of msgs){
    if(m.ts>cutoff){
      addMsg(m.nick,m.text,m.self,m.from,false,m.ts);
    }
  }
}

function leaveRoom(){
  if(S.dc)S.dc.close();
  if(S.pc)S.pc.close();
  S.dc=null;
  S.pc=null;
  Storage.del('session');
  showHome();
}

// ============== UTILS ==============
function escapeHtml(t){
  const d=document.createElement('div');
  d.textContent=t;
  return d.innerHTML;
}

function sendToPeer(pubKey,msg){
  // In mesh, broadcast to all, they filter by pubkey
  if(S.dc&&S.dc.readyState==='open'){
    S.dc.send(JSON.stringify({...msg,to:pubKey}));
  }
}

// ============== INIT ==============
function checkUrlHash(){
  const hash=location.hash.slice(1);
  if(!hash)return false;

  if(hash.startsWith('A=')){
    // Answer code for admin
    const code=decodeURIComponent(hash.slice(2));
    showHome();
    setTimeout(()=>{
      showAnswer();
      $('ans-in').value=code;
    },100);
    return true;
  }else{
    // Invite code for joiner
    const code=decodeURIComponent(hash);
    if(code.startsWith('G:')){
      showJoin(code);
      return true;
    }
  }
  return false;
}

if(!checkUrlHash())showHome();
</script>
</body>
</html>
