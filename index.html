<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ghost</title>
<style>
:root{--bg:#0a0f0a;--s:#0d1a0d;--b:#1a331a;--t:#e0f0e0;--dim:#7a9a7a;--acc:#4ade80;--grn:#22c55e;--red:#ef4444;--font:system-ui,-apple-system,sans-serif}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100vh;overflow:hidden}
body{background:var(--bg);color:var(--t);font-family:var(--font);font-size:14px;position:relative}
body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:radial-gradient(1px 1px at 20px 30px,#4ade80,transparent),radial-gradient(1px 1px at 50px 160px,#4ade80,transparent),radial-gradient(2px 2px at 200px 50px,#22c55e,transparent),radial-gradient(1px 1px at 400px 30px,#4ade80,transparent);background-size:500px 200px;opacity:0.4;pointer-events:none;z-index:-1}
.center{display:flex;justify-content:center;align-items:center;height:100vh;padding:20px}
.box{background:var(--s);border:1px solid var(--b);border-radius:12px;padding:32px;max-width:400px;width:100%;text-align:center}
h1{font-size:28px;margin-bottom:8px;color:#fff}
p{color:var(--dim);margin-bottom:24px;font-size:13px}
input,textarea{background:var(--bg);color:var(--t);border:1px solid var(--b);padding:12px 16px;font-size:14px;border-radius:8px;width:100%;outline:none;margin:8px 0}
input:focus,textarea:focus{border-color:var(--acc)}
button{background:var(--acc);color:#000;border:none;padding:12px 24px;font-size:14px;font-weight:600;border-radius:8px;cursor:pointer;width:100%;margin-top:16px}
button:hover{background:#22c55e}
button.secondary{background:transparent;color:var(--t);border:1px solid var(--b)}
button.secondary:hover{border-color:var(--acc)}
.code-box{background:var(--bg);border:1px solid var(--b);border-radius:8px;padding:16px;font-family:monospace;font-size:12px;word-break:break-all;margin:16px 0}
.qr-wrap{background:#fff;border-radius:8px;padding:16px;display:inline-block;margin:16px 0}
#messages{position:fixed;top:0;left:0;right:0;bottom:70px;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:8px}
#input-area{position:fixed;bottom:0;left:0;right:0;padding:12px 16px;background:var(--s);border-top:1px solid var(--b);display:flex;gap:10px;align-items:center}
#msg-input{flex:1;margin:0;background:var(--bg);border:1px solid var(--b);color:var(--t);padding:10px 14px;border-radius:20px;outline:none}
#msg-input:focus{border-color:var(--acc)}
#send-btn{width:auto;padding:10px 20px;margin:0;border-radius:20px}
.msg{padding:10px 14px;background:var(--s);border-radius:16px;border:1px solid var(--b);max-width:75%;word-break:break-word;align-self:flex-start}
.msg.self{align-self:flex-end;background:var(--acc);color:#000;border-color:var(--acc)}
.msg.self .nick{color:rgba(0,0,0,0.6)}
.msg .nick{font-size:11px;color:var(--dim);margin-bottom:2px;font-weight:600}
.msg .text{font-size:14px;line-height:1.4}
.hidden{display:none}
</style>
</head>
<body>
<div id="app"></div>
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<script>
const STUN=[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}];
const S={pc:null,dc:null,key:null,room:null,nick:null,myId:crypto.randomUUID()};
const $=id=>document.getElementById(id);
const rnd=(n=4)=>[...crypto.getRandomValues(new Uint8Array(n))].map(b=>b.toString(16).padStart(2,'0')).join('');
const b64url=buf=>btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
const unb64=s=>{s=s.replace(/-/g,'+').replace(/_/g,'/');while(s.length%4)s+='=';return Uint8Array.from(atob(s),c=>c.charCodeAt(0))};

async function genKey(){return crypto.subtle.generateKey({name:'AES-GCM',length:256},true,['encrypt','decrypt'])}
async function expKey(k){return b64url(await crypto.subtle.exportKey('raw',k))}
async function impKey(s){return crypto.subtle.importKey('raw',unb64(s),{name:'AES-GCM'},true,['encrypt','decrypt'])}
async function enc(k,txt){const iv=crypto.getRandomValues(new Uint8Array(12));const ct=new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM',iv},k,new TextEncoder().encode(txt)));const r=new Uint8Array(12+ct.length);r.set(iv);r.set(ct,12);return b64url(r)}
async function dec(k,data){const buf=unb64(data),iv=buf.slice(0,12),ct=buf.slice(12);return new TextDecoder().decode(await crypto.subtle.decrypt({name:'AES-GCM',iv},k,ct))}

async function compress(s){const c=new CompressionStream('deflate');const w=new Blob([s]).stream().pipeThrough(c);return b64url(new Uint8Array(await new Response(w).arrayBuffer()))}
async function decompress(s){const d=new DecompressionStream('deflate');const w=new Blob([unb64(s)]).stream().pipeThrough(d);return new Response(w).text()}

function showHome(){
  $('app').innerHTML=`<div class="center"><div class="box">
    <h1>Ghost</h1>
    <p>Temporary private chat. No logs. No servers.</p>
    <input id="nick-in" placeholder="Your name" maxlength="20" value="${localStorage.getItem('ghost-nick')||''}">
    <button onclick="doCreate()">Create Room</button>
    <button class="secondary" onclick="showJoin()">Join Room</button>
  </div></div>`;
}

async function doCreate(){
  S.nick=$('nick-in').value.trim()||'Ghost'+rnd(2);
  localStorage.setItem('ghost-nick',S.nick);
  S.room=rnd(4);
  S.key=await genKey();
  const keyStr=await expKey(S.key);

  const pc=new RTCPeerConnection({iceServers:STUN});
  const dc=pc.createDataChannel('chat',{ordered:true});
  setupDC(dc);

  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  await new Promise(r=>{if(pc.iceGatheringState==='complete')r();else pc.onicegatheringstatechange=()=>{if(pc.iceGatheringState==='complete')r()};setTimeout(r,3000)});

  const code='G:'+S.room+'.'+keyStr+'.'+await compress(pc.localDescription.sdp);
  S.pc=pc;

  $('app').innerHTML=`<div class="center"><div class="box">
    <h1>Share This Code</h1>
    <p>Send to the other person any way you want.</p>
    <div class="qr-wrap" id="qr"></div>
    <div class="code-box" id="code"></div>
    <button onclick="copyCode()">Copy</button>
    <button class="secondary" onclick="showAnswer()">I've Been Sent a Code</button>
  </div></div>`;

  $('code').textContent=code;
  // Truncate display if too long
  if(code.length>200){
    $('code').textContent=code.slice(0,100)+'...'+code.slice(-50)+'\n('+code.length+' chars - use copy button)';
  }
  // Smaller QR
  const qr=qrcode(0,'L');qr.addData(code);qr.make();
  $('qr').innerHTML=qr.createSvgTag({cellSize:2,margin:1});
  window.currentCode=code;
}

function copyCode(){navigator.clipboard.writeText(window.currentCode);}

function showJoin(){
  S.nick=$('nick-in').value.trim()||'Ghost'+rnd(2);
  localStorage.setItem('ghost-nick',S.nick);
  $('app').innerHTML=`<div class="center"><div class="box">
    <h1>Enter Code</h1>
    <p>Paste the code they sent you.</p>
    <textarea id="code-in" rows="3" placeholder="G:..."></textarea>
    <button onclick="doJoin()">Connect</button>
    <button class="secondary" onclick="showHome()">Back</button>
  </div></div>`;
  $('code-in').focus();
}

async function doJoin(){
  const input=$('code-in').value.trim();
  if(!input.startsWith('G:')){alert('Invalid code');return}
  const parts=input.slice(2).split('.');
  if(parts.length!==3){alert('Invalid code');return}

  S.room=parts[0];
  S.key=await impKey(parts[1]);
  const offerSDP=await decompress(parts[2]);

  const pc=new RTCPeerConnection({iceServers:STUN});
  let dcResolve;
  const dcPromise=new Promise(r=>dcResolve=r);
  pc.ondatachannel=e=>dcResolve(e.channel);

  await pc.setRemoteDescription({type:'offer',sdp:offerSDP});
  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await new Promise(r=>{if(pc.iceGatheringState==='complete')r();else pc.onicegatheringstatechange=()=>{if(pc.iceGatheringState==='complete')r()};setTimeout(r,3000)});

  S.pc=pc;
  const answerCode='A:'+await compress(pc.localDescription.sdp);

  $('app').innerHTML=`<div class="center"><div class="box">
    <h1>Show This Back</h1>
    <p>They need to scan or paste this to complete.</p>
    <div class="qr-wrap" id="qr"></div>
    <div class="code-box" id="code"></div>
    <button onclick="copyCode()">Copy</button>
  </div></div>`;

  $('code').textContent=answerCode;
  window.currentCode=answerCode;
  // Smaller QR for answer too
  const qr=qrcode(0,'L');qr.addData(answerCode);qr.make();
  $('qr').innerHTML=qr.createSvgTag({cellSize:2,margin:1});

  const dc=await dcPromise;
  setupDC(dc);
}

function showAnswer(){
  $('app').innerHTML=`<div class="center"><div class="box">
    <h1>Enter Their Response</h1>
    <p>Paste the code they sent back.</p>
    <textarea id="ans-in" rows="3" placeholder="A:..."></textarea>
    <button onclick="acceptAnswer()">Connect</button>
  </div></div>`;
}

async function acceptAnswer(){
  const input=$('ans-in').value.trim();
  if(!input.startsWith('A:')){alert('Invalid code');return}
  const answerSDP=await decompress(input.slice(2));
  await S.pc.setRemoteDescription({type:'answer',sdp:answerSDP});
}

function setupDC(dc){
  S.dc=dc;
  dc.onopen=()=>showChat();
  dc.onmessage=async e=>{
    const msg=JSON.parse(await dec(S.key,e.data));
    addMsg(msg.nick,msg.text,false);
  };
}

function showChat(){
  $('app').innerHTML=`<div id="messages"></div>
  <div id="input-area">
    <input id="msg-input" placeholder="Type a message..." autocomplete="off">
    <button id="send-btn" onclick="sendMsg()">Send</button>
  </div>`;
  const input=$('msg-input');
  input.onkeypress=e=>{if(e.key==='Enter')sendMsg()};
  input.focus();
  addMsg('System','Connected! Chat is ephemeral.',false);
}

async function sendMsg(){
  const input=$('msg-input');
  const btn=$('send-btn');
  const text=input.value.trim();
  if(!text)return;
  if(!S.dc||S.dc.readyState!=='open'){alert('Not connected yet');return;}
  input.value='';
  btn.disabled=true;
  try{
    const msg={nick:S.nick,text,time:Date.now()};
    S.dc.send(await enc(S.key,JSON.stringify(msg)));
    addMsg(S.nick,text,true);
  }catch(e){console.error(e);alert('Send failed');}
  finally{btn.disabled=false;input.focus();}
}

function addMsg(nick,text,self){
  const div=document.createElement('div');
  div.className='msg'+(self?' self':'');
  div.innerHTML=`<div class="nick">${nick}</div><div class="text">${text}</div>`;
  const msgs=document.getElementById('messages');
  if(!msgs)return;
  msgs.appendChild(div);
  msgs.scrollTop=msgs.scrollHeight;
}

showHome();
</script>
</body>
</html>
