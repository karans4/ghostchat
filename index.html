<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<title>Ghost</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300..700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#09090b;--surface:#18181b;--surface2:#27272a;--surface3:#3f3f46;
  --border:#27272a;--border-hover:#3f3f46;
  --text:#fafafa;--text2:#a1a1aa;--text3:#71717a;
  --blue:#3b82f6;--blue-hover:#2563eb;--blue-ghost:rgba(59,130,246,.1);--blue-ghost2:rgba(59,130,246,.06);
  --green:#22c55e;--green-ghost:rgba(34,197,94,.15);
  --red:#ef4444;--red-ghost:rgba(239,68,68,.1);
  --amber:#f59e0b;--amber-ghost:rgba(245,158,11,.12);
  --radius:10px;--radius-lg:16px;--radius-xl:24px;
  --font:'Inter',system-ui,-apple-system,sans-serif;
  --mono:'SF Mono','Cascadia Code','Fira Code',monospace
}
html,body{height:100%;font-family:var(--font);background:var(--bg);color:var(--text);overflow:hidden;-webkit-font-smoothing:antialiased}
::selection{background:var(--blue);color:#fff}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:3px}

/* ---- layout ---- */
.scene{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:24px;position:relative}
.scene::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 60% at 50% -20%,var(--blue-ghost),transparent);pointer-events:none}

.panel{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xl);
  width:100%;max-width:440px;padding:40px;position:relative;
  box-shadow:0 0 0 1px rgba(255,255,255,.03),0 24px 48px -12px rgba(0,0,0,.6)
}

/* ---- icon system (svg in inline bg) ---- */
.icon{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;margin:0 auto 28px;position:relative}
.icon.blue{background:var(--blue-ghost);color:var(--blue)}
.icon.green{background:var(--green-ghost);color:var(--green)}
.icon.amber{background:var(--amber-ghost);color:var(--amber)}
.icon.red{background:var(--red-ghost);color:var(--red)}
.icon svg{width:24px;height:24px;stroke:currentColor;fill:none;stroke-width:1.75;stroke-linecap:round;stroke-linejoin:round}

/* ---- typography ---- */
h1{font-size:22px;font-weight:600;letter-spacing:-.3px;margin-bottom:6px}
.desc{color:var(--text2);font-size:14px;line-height:1.6;margin-bottom:28px}
.label{font-size:12px;font-weight:500;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}

/* ---- form ---- */
input,textarea{
  width:100%;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);
  padding:12px 14px;color:var(--text);font-size:14px;font-family:var(--font);
  outline:none;transition:border-color .15s,box-shadow .15s
}
input:focus,textarea:focus{border-color:var(--blue);box-shadow:0 0 0 3px var(--blue-ghost)}
input::placeholder,textarea::placeholder{color:var(--text3)}
textarea{resize:vertical;font-family:var(--mono);font-size:12px;line-height:1.5}

/* ---- buttons ---- */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:8px;
  padding:10px 18px;border-radius:var(--radius);border:none;
  font-size:14px;font-weight:500;font-family:var(--font);cursor:pointer;
  transition:all .15s;white-space:nowrap;user-select:none
}
.btn:active{transform:scale(.97)}
.btn-fill{background:var(--blue);color:#fff}
.btn-fill:hover{background:var(--blue-hover);box-shadow:0 4px 16px rgba(59,130,246,.3)}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--surface2);border-color:var(--border-hover);color:var(--text)}
.btn-danger{background:var(--red-ghost);color:var(--red);border:1px solid transparent}
.btn-danger:hover{background:var(--red);color:#fff}
.btn-sm{padding:7px 12px;font-size:13px;border-radius:8px}
.btn-block{width:100%}
.btn-row{display:flex;gap:10px;margin-top:16px}
.btn-row .btn{flex:1}

/* ---- code box ---- */
.code-display{
  background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);
  padding:14px;font-family:var(--mono);font-size:11px;line-height:1.6;
  color:var(--text2);word-break:break-all;max-height:140px;overflow-y:auto;
  margin:16px 0;cursor:text;user-select:all;transition:border-color .15s
}
.code-display:hover{border-color:var(--border-hover)}

/* ---- divider ---- */
.divider{height:1px;background:var(--border);margin:28px 0}

/* ---- spinner ---- */
.spinner{display:flex;align-items:center;gap:10px;color:var(--text3);font-size:13px;margin-top:20px;justify-content:center}
.spinner::before{content:'';width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ---- chat layout ---- */
#chat{position:fixed;inset:0;display:flex;flex-direction:column;background:var(--bg)}
#chat-head{
  padding:12px 20px;background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0;
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)
}
#chat-head .room-info{display:flex;align-items:center;gap:12px}
#chat-head .room-name{font-size:15px;font-weight:600}
#chat-head .room-meta{font-size:12px;color:var(--text3)}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0}
#chat-head .actions{display:flex;gap:6px}
.icon-btn{
  width:36px;height:36px;border-radius:8px;border:none;background:transparent;
  color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .15s
}
.icon-btn:hover{background:var(--surface2);color:var(--text)}
.icon-btn svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:1.75;stroke-linecap:round;stroke-linejoin:round}

/* ---- messages ---- */
#msgs{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:2px}
.msg{max-width:70%;padding:10px 14px;font-size:14px;line-height:1.5;animation:msgIn .25s ease;position:relative}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

.msg.in{
  align-self:flex-start;background:var(--surface);border-radius:4px 16px 16px 16px;
  border:1px solid var(--border)
}
.msg.out{
  align-self:flex-end;background:var(--blue);color:#fff;border-radius:16px 16px 4px 16px
}
.msg .who{font-size:11px;font-weight:600;color:var(--blue);margin-bottom:3px}
.msg.out .who{color:rgba(255,255,255,.7)}
.msg .when{font-size:11px;color:var(--text3);margin-top:4px;text-align:right}
.msg.out .when{color:rgba(255,255,255,.5)}
.msg.system{
  align-self:center;max-width:100%;background:transparent;border:none;
  color:var(--text3);font-size:12px;padding:8px 0;text-align:center
}

.msg .file-chip{
  display:flex;align-items:center;gap:10px;padding:10px 14px;margin-top:8px;
  background:rgba(0,0,0,.2);border-radius:8px;cursor:pointer;transition:background .15s
}
.msg .file-chip:hover{background:rgba(0,0,0,.3)}
.msg .file-chip .f-icon{width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.msg .file-chip .f-icon svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:1.75}
.msg .file-chip .f-info{font-size:13px;line-height:1.3}
.msg .file-chip .f-size{font-size:11px;opacity:.6}

.msg.selected{outline:2px solid var(--blue);outline-offset:2px;border-radius:16px}

/* ---- input bar ---- */
#input-bar{
  padding:12px 16px;background:var(--surface);border-top:1px solid var(--border);
  display:flex;align-items:center;gap:10px;flex-shrink:0
}
#input-bar input{margin:0;background:var(--bg);flex:1}
#input-bar .icon-btn{flex-shrink:0}
#send{
  width:36px;height:36px;border-radius:8px;border:none;background:var(--blue);
  color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .15s;flex-shrink:0
}
#send:hover{background:var(--blue-hover)}
#send:active{transform:scale(.92)}
#send svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

/* ---- selection bar ---- */
#sel-bar{
  display:none;padding:8px 16px;background:var(--blue-ghost2);border-bottom:1px solid var(--border);
  align-items:center;justify-content:space-between;font-size:13px;color:var(--text2)
}
#sel-bar.show{display:flex}
#sel-bar .sel-actions{display:flex;gap:6px}

/* ---- drop overlay ---- */
#drop{
  position:fixed;inset:0;background:rgba(9,9,11,.92);display:none;
  flex-direction:column;align-items:center;justify-content:center;z-index:200;
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)
}
#drop.show{display:flex}
#drop .drop-ring{
  width:120px;height:120px;border-radius:50%;border:2px dashed var(--blue);
  display:flex;align-items:center;justify-content:center;margin-bottom:20px;
  animation:dropPulse 2s ease infinite
}
@keyframes dropPulse{0%,100%{opacity:.5;transform:scale(1)}50%{opacity:1;transform:scale(1.05)}}
#drop .drop-ring svg{width:40px;height:40px;stroke:var(--blue);fill:none;stroke-width:1.5}
#drop p{color:var(--text2);font-size:15px}

/* ---- modal ---- */
.modal-bg{
  position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;
  justify-content:center;z-index:300;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)
}
.modal-bg.show{display:flex}
.modal-box{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);
  padding:28px;max-width:400px;width:90%;max-height:85vh;overflow-y:auto;
  box-shadow:0 24px 48px -12px rgba(0,0,0,.5)
}
.modal-box h3{font-size:17px;font-weight:600;margin-bottom:8px}
.modal-box .mdesc{color:var(--text2);font-size:13px;margin-bottom:20px;line-height:1.5}
.qr-frame{background:#fff;border-radius:12px;padding:16px;display:inline-block;margin:0 auto}

/* ---- settings drawer ---- */
#drawer{
  position:fixed;top:0;right:0;width:380px;max-width:100vw;height:100%;
  background:var(--surface);border-left:1px solid var(--border);
  transform:translateX(100%);transition:transform .25s ease;z-index:250;
  display:flex;flex-direction:column
}
#drawer.open{transform:translateX(0)}
#drawer-head{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
#drawer-head h3{font-size:16px;font-weight:600}
#drawer-body{padding:20px;overflow-y:auto;flex:1}
.drawer-section{margin-bottom:28px}
.drawer-section h4{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:14px}
.drawer-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0}
.drawer-row span{font-size:14px}
.drawer-row .val{font-size:13px;color:var(--text2);font-family:var(--mono)}
.toggle{width:40px;height:22px;border-radius:11px;background:var(--surface3);position:relative;cursor:pointer;transition:background .2s}
.toggle.on{background:var(--blue)}
.toggle::after{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:2px;left:2px;transition:transform .2s}
.toggle.on::after{transform:translateX(18px)}
.drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:240;display:none}
.drawer-overlay.show{display:block}

.badge{display:inline-flex;padding:3px 8px;border-radius:6px;font-size:11px;font-weight:600;letter-spacing:.3px}
.badge-blue{background:var(--blue-ghost);color:var(--blue)}
.badge-amber{background:var(--amber-ghost);color:var(--amber)}

.hidden{display:none}
</style>
</head>
<body>

<div id="app"></div>

<div id="drop">
  <div class="drop-ring"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
  <p>Drop files to send</p>
</div>

<div id="drawer-overlay" class="drawer-overlay" onclick="closeDrawer()"></div>
<div id="drawer">
  <div id="drawer-head"><h3>Room</h3><button class="icon-btn" onclick="closeDrawer()"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
  <div id="drawer-body"></div>
</div>

<div id="modal-bg" class="modal-bg" onclick="closeModal()">
  <div class="modal-box" id="modal-box" onclick="event.stopPropagation()"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<script>
// ============== SVG ICONS ==============
const ICO={
  ghost:`<svg viewBox="0 0 24 24"><path d="M9 10h.01M15 10h.01M12 2a8 8 0 0 0-8 8v12l3-3 2 2 3-3 3 3 2-2 3 3V10a8 8 0 0 0-8-8z"/></svg>`,
  shield:`<svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
  key:`<svg viewBox="0 0 24 24"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>`,
  send2:`<svg viewBox="0 0 24 24"><path d="M3.714 3.048a.498.498 0 0 0-.683.627l2.843 7.627a2 2 0 0 1 0 1.396l-2.842 7.627a.498.498 0 0 0 .682.627l18.168-8.215a.5.5 0 0 0 0-.904z"/><line x1="6" y1="12" x2="22" y2="12"/></svg>`,
  copy:`<svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`,
  qr:`<svg viewBox="0 0 24 24"><rect x="2" y="2" width="8" height="8" rx="1"/><rect x="14" y="2" width="8" height="8" rx="1"/><rect x="2" y="14" width="8" height="8" rx="1"/><rect x="14" y="14" width="4" height="4"/><rect x="20" y="20" width="2" height="2"/><rect x="14" y="20" width="2" height="2"/><rect x="20" y="14" width="2" height="2"/></svg>`,
  clip:`<svg viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>`,
  settings:`<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`,
  x:`<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
  arrow:`<svg viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>`,
  file:`<svg viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>`,
  download:`<svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`,
  skull:`<svg viewBox="0 0 24 24"><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="M12.5 17-.5-1h-1l-.5 1"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></svg>`,
  back:`<svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>`,
  users:`<svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
  lock:`<svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
};

// ============== CRYPTO ==============
const b64url=buf=>btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
const unb64=s=>{s=s.replace(/-/g,'+').replace(/_/g,'/');while(s.length%4)s+='=';return Uint8Array.from(atob(s),c=>c.charCodeAt(0))};
const rnd=(n=4)=>[...crypto.getRandomValues(new Uint8Array(n))].map(b=>b.toString(16).padStart(2,'0')).join('');

async function genAESKey(){return crypto.subtle.generateKey({name:'AES-GCM',length:256},true,['encrypt','decrypt'])}
async function expAESKey(k){return b64url(await crypto.subtle.exportKey('raw',k))}
async function impAESKey(s){return crypto.subtle.importKey('raw',unb64(s),{name:'AES-GCM'},true,['encrypt','decrypt'])}
async function aesEnc(k,txt){const iv=crypto.getRandomValues(new Uint8Array(12));const ct=new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM',iv},k,new TextEncoder().encode(txt)));const r=new Uint8Array(12+ct.length);r.set(iv);r.set(ct,12);return b64url(r)}
async function aesDec(k,data){const buf=unb64(data),iv=buf.slice(0,12),ct=buf.slice(12);return new TextDecoder().decode(await crypto.subtle.decrypt({name:'AES-GCM',iv},k,ct))}

async function genECDSAKey(){return crypto.subtle.generateKey({name:'ECDSA',namedCurve:'P-256'},true,['sign','verify'])}
async function expECDSAPub(k){return b64url(await crypto.subtle.exportKey('spki',k))}
async function impECDSAPub(s){return crypto.subtle.importKey('spki',unb64(s),{name:'ECDSA',namedCurve:'P-256'},true,['verify'])}
async function signData(privKey,data){const sig=await crypto.subtle.sign({name:'ECDSA',hash:'SHA-256'},privKey,new TextEncoder().encode(data));return b64url(sig)}
async function verifyData(pubKey,data,sig){return crypto.subtle.verify({name:'ECDSA',hash:'SHA-256'},pubKey,unb64(sig),new TextEncoder().encode(data))}

async function compress(s){const c=new CompressionStream('deflate');const w=new Blob([s]).stream().pipeThrough(c);return b64url(new Uint8Array(await new Response(w).arrayBuffer()))}
async function decompress(s){const d=new DecompressionStream('deflate');const w=new Blob([unb64(s)]).stream().pipeThrough(d);return new Response(w).text()}

// ============== STATE ==============
const STUN=[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}];
const $=id=>document.getElementById(id);
const S={pc:null,dc:null,roomKey:null,roomId:null,nick:null,myId:crypto.randomUUID(),myKeyPair:null,myPubKey:null,adminPubKey:null,isAdmin:false,peers:new Map(),selectedMessages:new Set(),files:new Map(),msgTTL:4*60*60*1000};

const Store={
  get(k){try{return JSON.parse(localStorage.getItem('g:'+k))}catch(e){return null}},
  set(k,v){localStorage.setItem('g:'+k,JSON.stringify(v))},
  del(k){localStorage.removeItem('g:'+k)},
  clear(){Object.keys(localStorage).filter(k=>k.startsWith('g:')).forEach(k=>localStorage.removeItem(k))}
};

// ============== SCREENS ==============
function showHome(){
  const saved=Store.get('session');
  $('app').innerHTML=`<div class="scene"><div class="panel">
    <div class="icon blue">${ICO.ghost}</div>
    <h1>Ghost</h1>
    <p class="desc">End-to-end encrypted chat. No servers, no logs, no trace.</p>
    <input id="nick-in" placeholder="Display name" maxlength="20" value="${Store.get('nick')||''}" style="margin-bottom:8px">
    <div class="btn-row"><button class="btn btn-fill btn-block" onclick="doCreate()">Create room</button></div>
    <div class="btn-row" style="margin-top:8px"><button class="btn btn-ghost btn-block" onclick="showJoin()">Join room</button></div>
    ${saved?'<div class="btn-row" style="margin-top:8px"><button class="btn btn-ghost btn-block" onclick="restoreSession()">Reconnect</button></div>':''}
  </div></div>`;
}

async function doCreate(){
  S.nick=$('nick-in').value.trim()||'Ghost'+rnd(2);
  Store.set('nick',S.nick);
  S.roomId=rnd(8);S.roomKey=await genAESKey();S.isAdmin=true;
  S.myKeyPair=await genECDSAKey();S.myPubKey=await expECDSAPub(S.myKeyPair.publicKey);
  S.adminPubKey=S.myPubKey;

  const pc=new RTCPeerConnection({iceServers:STUN});
  const dc=pc.createDataChannel('chat',{ordered:true});
  setupDC(dc);
  const offer=await pc.createOffer();await pc.setLocalDescription(offer);await waitICE(pc);

  const roomKeyStr=await expAESKey(S.roomKey);
  const code='G:'+S.roomId+'.'+roomKeyStr+'.'+S.myPubKey+'.'+await compress(pc.localDescription.sdp);
  S.pc=pc;saveSession();window.currentCode=code;

  $('app').innerHTML=`<div class="scene"><div class="panel">
    <div class="icon amber">${ICO.shield}</div>
    <h1>Room created</h1>
    <p class="desc">Share this invite code. It contains the encryption key and connection data.</p>
    <div class="label">Invite code</div>
    <div class="code-display" id="code-out">${code}</div>
    <div class="btn-row">
      <button class="btn btn-fill" onclick="doCopy()">${ICO.copy} Copy</button>
      <button class="btn btn-ghost" onclick="doShowQR()">${ICO.qr} QR code</button>
    </div>
    <div class="divider"></div>
    <div class="label">Next step</div>
    <p class="desc" style="margin-bottom:12px">Once they send back a reply code, paste it here.</p>
    <textarea id="ans-in" rows="3" placeholder="Paste reply code (A:...)"></textarea>
    <div class="btn-row"><button class="btn btn-fill btn-block" onclick="acceptAnswer()">Connect ${ICO.arrow}</button></div>
    <div style="text-align:center;margin-top:12px"><button class="btn btn-ghost btn-sm" onclick="showHome()">${ICO.back} Back</button></div>
  </div></div>`;
}

function showJoin(prefill){
  S.nick=Store.get('nick')||'Ghost'+rnd(2);Store.set('nick',S.nick);
  $('app').innerHTML=`<div class="scene"><div class="panel">
    <div class="icon green">${ICO.key}</div>
    <h1>Join room</h1>
    <p class="desc">Paste the invite code you received.</p>
    <textarea id="code-in" rows="4" placeholder="Paste invite code (G:...)"></textarea>
    <div class="btn-row"><button class="btn btn-fill btn-block" onclick="doJoin()">Join ${ICO.arrow}</button></div>
    <div style="text-align:center;margin-top:12px"><button class="btn btn-ghost btn-sm" onclick="showHome()">${ICO.back} Back</button></div>
  </div></div>`;
  if(prefill){$('code-in').value=prefill;doJoin();}
  else $('code-in').focus();
}

async function doJoin(){
  const raw=$('code-in').value.trim();
  if(!raw.startsWith('G:')){alert('Invalid code');return}
  const p=raw.slice(2).split('.');if(p.length!==4){alert('Invalid code');return}

  S.roomId=p[0];S.roomKey=await impAESKey(p[1]);S.adminPubKey=p[2];S.isAdmin=false;
  S.myKeyPair=await genECDSAKey();S.myPubKey=await expECDSAPub(S.myKeyPair.publicKey);
  const offerSDP=await decompress(p[3]);

  const pc=new RTCPeerConnection({iceServers:STUN});
  let dcR;const dcP=new Promise(r=>dcR=r);
  pc.ondatachannel=e=>dcR(e.channel);
  await pc.setRemoteDescription({type:'offer',sdp:offerSDP});
  const ans=await pc.createAnswer();await pc.setLocalDescription(ans);await waitICE(pc);

  S.pc=pc;
  const answerCode='A:'+S.myPubKey+'.'+await compress(pc.localDescription.sdp);
  saveSession();window.currentCode=answerCode;

  $('app').innerHTML=`<div class="scene"><div class="panel">
    <div class="icon green">${ICO.lock}</div>
    <h1>Send reply</h1>
    <p class="desc">Copy this code and send it back to the room admin.</p>
    <div class="label">Reply code</div>
    <div class="code-display" id="code-out">${answerCode}</div>
    <div class="btn-row">
      <button class="btn btn-fill" onclick="doCopy()">${ICO.copy} Copy</button>
      <button class="btn btn-ghost" onclick="doShowQR()">${ICO.qr} QR code</button>
    </div>
    <div class="spinner">Waiting for connection...</div>
  </div></div>`;

  const dc=await dcP;setupDC(dc);
}

async function acceptAnswer(){
  const raw=$('ans-in').value.trim();
  if(!raw.startsWith('A:')){alert('Needs to start with A:');return}
  const p=raw.slice(2).split('.');if(p.length!==2){alert('Invalid reply code');return}
  await S.pc.setRemoteDescription({type:'answer',sdp:await decompress(p[1])});
}

async function waitICE(pc){return new Promise(r=>{if(pc.iceGatheringState==='complete')r();else pc.onicegatheringstatechange=()=>{if(pc.iceGatheringState==='complete')r()};setTimeout(r,3000)})}

function doCopy(){
  navigator.clipboard.writeText(window.currentCode);
  const b=document.querySelector('.btn-fill');if(!b)return;
  const orig=b.innerHTML;b.innerHTML='Copied!';b.style.background='var(--green)';
  setTimeout(()=>{b.innerHTML=orig;b.style.background=''},1500);
}

function doShowQR(){
  const link=location.origin+location.pathname+'#'+encodeURIComponent(window.currentCode);
  $('modal-bg').classList.add('show');
  $('modal-box').innerHTML=`
    <h3>Scan to join</h3>
    <p class="mdesc">Scanning this QR code will open Ghost with the code pre-filled.</p>
    <div style="text-align:center"><div class="qr-frame" id="qr-target"></div></div>
    <p style="font-size:11px;color:var(--text3);word-break:break-all;margin-top:16px;font-family:var(--mono)">${link}</p>
    <div class="btn-row" style="margin-top:16px"><button class="btn btn-ghost btn-block" onclick="closeModal()">Close</button></div>`;
  const q=qrcode(0,'L');q.addData(link);q.make();
  $('qr-target').innerHTML=q.createSvgTag({cellSize:4,margin:1});
}

function closeModal(){$('modal-bg').classList.remove('show')}

// ============== CHAT ==============
function showChat(){
  $('app').innerHTML=`<div id="chat">
    <div id="chat-head">
      <div class="room-info">
        <div class="status-dot"></div>
        <div>
          <div class="room-name">Ghost</div>
          <div class="room-meta">${S.isAdmin?'Admin':'Member'} &middot; E2EE &middot; ${S.roomId.slice(0,8)}</div>
        </div>
      </div>
      <div class="actions">
        <button class="icon-btn" onclick="openDrawer()" title="Settings">${ICO.settings}</button>
        <button class="icon-btn" style="color:var(--red)" onclick="leaveRoom()" title="Leave">${ICO.x}</button>
      </div>
    </div>
    <div id="sel-bar"><span id="sel-info">0 selected</span><div class="sel-actions">
      <button class="btn btn-sm btn-ghost" onclick="copySelected()">Copy</button>
      <button class="btn btn-sm btn-ghost" onclick="dlSelected()">Download</button>
      <button class="btn btn-sm btn-ghost" onclick="clearSel()">Cancel</button>
    </div></div>
    <div id="msgs"></div>
    <div id="input-bar">
      <input type="file" id="file-in" style="display:none" onchange="handleFileSelect(event)" multiple>
      <button class="icon-btn" onclick="$('file-in').click()" title="Attach file">${ICO.clip}</button>
      <input id="msg-in" placeholder="Message..." autocomplete="off">
      <button id="send" onclick="sendMsg()">${ICO.send2}</button>
    </div>
  </div>`;
  $('msg-in').onkeydown=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg()}};
  $('msg-in').focus();
  setupDragDrop();loadStoredMessages();
  addSystemMsg('Connected. End-to-end encrypted. Messages expire after 4 hours.');
}

function setupDragDrop(){
  const d=$('drop');
  document.body.ondragover=e=>{e.preventDefault();d.classList.add('show')};
  document.body.ondragleave=e=>{if(e.target===d)d.classList.remove('show')};
  document.body.ondrop=e=>{e.preventDefault();d.classList.remove('show');if(e.dataTransfer.files.length)handleFiles(e.dataTransfer.files)};
  $('msgs').onclick=e=>{const m=e.target.closest('.msg');if(!m||m.classList.contains('system'))return;if(e.ctrlKey||e.metaKey||e.shiftKey){e.preventDefault();toggleSel(m)}};
}

function setupDC(dc){
  S.dc=dc;
  dc.onopen=()=>showChat();
  dc.onmessage=async e=>{try{await handleMessage(JSON.parse(await aesDec(S.roomKey,e.data)))}catch(err){console.error('decrypt fail:',err)}};
  dc.onclose=()=>addSystemMsg('Peer disconnected.');
}

async function handleMessage(payload){
  if(payload.sig&&payload.fromPubKey){
    const pk=await impECDSAPub(payload.fromPubKey);
    if(!await verifyData(pk,JSON.stringify(payload.data),payload.sig)){console.error('bad sig');return}
  }
  const m=payload.data;
  switch(m.type){
    case 'chat':addMsg(m.nick,m.text,false,m.ts);storeMessage(m);break;
    case 'file':addFileMsg(m.nick,m.name,m.size,false,m.fileId);break;
    case 'admin-action':await handleAdminAction(m);break;
    case 'self-destruct':handleSelfDestruct();break;
  }
}

async function sendMsg(){
  const inp=$('msg-in');const text=inp.value.trim();if(!text)return;
  if(!S.dc||S.dc.readyState!=='open'){alert('Not connected');return}
  inp.value='';
  const m={type:'chat',from:S.myId,nick:S.nick,text,ts:Date.now()};
  const p=await signPayload(m);
  S.dc.send(await aesEnc(S.roomKey,JSON.stringify(p)));
  addMsg(S.nick,text,true,m.ts);storeMessage({...m,self:true});
}

async function signPayload(data){
  return{data,sig:await signData(S.myKeyPair.privateKey,JSON.stringify(data)),fromPubKey:S.myPubKey};
}

function addMsg(nick,text,self,ts){
  const d=document.createElement('div');
  d.className='msg '+(self?'out':'in');
  d.dataset.ts=ts||Date.now();
  const t=new Date(ts||Date.now()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  d.innerHTML=`${self?'':`<div class="who">${esc(nick)}</div>`}<div>${esc(text)}</div><div class="when">${t}</div>`;
  const c=$('msgs');if(!c)return;c.appendChild(d);c.scrollTop=c.scrollHeight;
}

function addSystemMsg(text){
  const d=document.createElement('div');d.className='msg system';d.textContent=text;
  const c=$('msgs');if(!c)return;c.appendChild(d);c.scrollTop=c.scrollHeight;
}

// ============== FILES ==============
function handleFileSelect(e){if(e.target.files.length)handleFiles(e.target.files)}

async function handleFiles(files){
  for(const f of files){
    const reader=new FileReader();
    reader.onload=async e=>{
      const data=e.target.result;const fileId=rnd(16);
      S.files.set(fileId,{name:f.name,data,mime:f.type});
      const m={type:'file',from:S.myId,nick:S.nick,fileId,name:f.name,size:f.size,mime:f.type,ts:Date.now()};
      const p=await signPayload(m);S.dc.send(await aesEnc(S.roomKey,JSON.stringify(p)));
      addFileMsg(S.nick,f.name,f.size,true,fileId);
    };reader.readAsDataURL(f);
  }
}

function addFileMsg(nick,name,size,self,fileId){
  const d=document.createElement('div');d.className='msg '+(self?'out':'in');d.dataset.fileId=fileId;d.dataset.ts=Date.now();
  d.innerHTML=`${self?'':`<div class="who">${esc(nick)}</div>`}
    <div class="file-chip" onclick="dlFile('${fileId}')">
      <div class="f-icon">${ICO.file}</div>
      <div class="f-info"><div>${esc(name)}</div><div class="f-size">${fmtBytes(size)}</div></div>
    </div>`;
  const c=$('msgs');if(!c)return;c.appendChild(d);c.scrollTop=c.scrollHeight;
}

function dlFile(id){
  const f=S.files.get(id);if(!f){alert('File not available');return}
  const a=document.createElement('a');a.href=f.data;a.download=f.name;a.click();
}

function fmtBytes(b){if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(1)+' MB'}

// ============== SELECTION ==============
function toggleSel(el){
  const id=el.dataset.ts;
  if(S.selectedMessages.has(id)){S.selectedMessages.delete(id);el.classList.remove('selected')}
  else{S.selectedMessages.add(id);el.classList.add('selected')}
  updSel();
}
function updSel(){
  const b=$('sel-bar');const n=S.selectedMessages.size;
  if(n>0){b.classList.add('show');$('sel-info').textContent=n+' selected'}else b.classList.remove('show');
}
function clearSel(){S.selectedMessages.clear();document.querySelectorAll('.msg.selected').forEach(e=>e.classList.remove('selected'));updSel()}
function copySelected(){
  const t=[];document.querySelectorAll('.msg').forEach(e=>{
    if(S.selectedMessages.has(e.dataset.ts)){const w=e.querySelector('.who');const txt=e.childNodes[w?1:0];t.push((w?w.textContent+': ':'')+txt.textContent)}
  });navigator.clipboard.writeText(t.join('\n'));clearSel();
}
function dlSelected(){document.querySelectorAll('.msg').forEach(e=>{if(S.selectedMessages.has(e.dataset.ts)&&e.dataset.fileId)dlFile(e.dataset.fileId)});clearSel()}

// ============== ADMIN ==============
async function handleAdminAction(msg){
  const ak=await impECDSAPub(S.adminPubKey);
  if(!await verifyData(ak,JSON.stringify(msg.action),msg.sig)){console.error('bad admin sig');return}
  if(msg.action.type==='self-destruct')handleSelfDestruct();
  if(msg.action.type==='kick'&&msg.action.target===S.myId){alert('Removed by admin');leaveRoom()}
}
async function sendAdminAction(action){
  if(!S.isAdmin)return;
  const sig=await signData(S.myKeyPair.privateKey,JSON.stringify(action));
  S.dc.send(await aesEnc(S.roomKey,JSON.stringify({type:'admin-action',action,sig})));
}
function handleSelfDestruct(){
  Store.clear();S.files.clear();
  const m=$('msgs');if(m)m.innerHTML='';
  addSystemMsg('Room destroyed. All data wiped.');
  setTimeout(()=>leaveRoom(),2000);
}

// ============== DRAWER ==============
function openDrawer(){
  $('drawer').classList.add('open');$('drawer-overlay').classList.add('show');
  let h=`<div class="drawer-section"><h4>Room</h4>
    <div class="drawer-row"><span>Room ID</span><span class="val">${S.roomId}</span></div>
    <div class="drawer-row"><span>Role</span><span class="badge ${S.isAdmin?'badge-amber':'badge-blue'}">${S.isAdmin?'Admin':'Member'}</span></div>
    <div class="drawer-row"><span>Encryption</span><span class="val">AES-256-GCM</span></div>
    <div class="drawer-row"><span>Signing</span><span class="val">ECDSA P-256</span></div>
  </div>`;
  if(S.isAdmin){
    h+=`<div class="drawer-section"><h4>Admin</h4>
      <button class="btn btn-ghost btn-block btn-sm" onclick="showInviteCode()" style="margin-bottom:8px">Show invite code</button>
      <button class="btn btn-danger btn-block btn-sm" onclick="confirmDestroy()">Destroy room</button>
    </div>`;
  }
  h+=`<div class="drawer-section"><h4>Data</h4>
    <div class="drawer-row"><span>Message TTL</span><span class="val">4 hours</span></div>
    <button class="btn btn-ghost btn-block btn-sm" onclick="exportMsgs()" style="margin-top:8px">Export messages</button>
  </div>`;
  $('drawer-body').innerHTML=h;
}
function closeDrawer(){$('drawer').classList.remove('open');$('drawer-overlay').classList.remove('show')}

function confirmDestroy(){if(!confirm('Destroy room and wipe all messages for everyone?'))return;sendAdminAction({type:'self-destruct',ts:Date.now()});handleSelfDestruct()}
function showInviteCode(){if(window.currentCode)alert(window.currentCode)}
function exportMsgs(){
  const d=Store.get('msg_'+S.roomId)||[];
  const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='ghost-'+S.roomId+'.json';a.click();
}

// ============== STORAGE ==============
function saveSession(){
  Store.set('session',{roomId:S.roomId,roomKey:expAESKey(S.roomKey),myId:S.myId,myPubKey:S.myPubKey,adminPubKey:S.adminPubKey,isAdmin:S.isAdmin,nick:S.nick});
}
async function restoreSession(){
  const s=Store.get('session');if(!s){alert('No saved session');return}
  S.roomId=s.roomId;S.roomKey=await impAESKey(s.roomKey);S.myId=s.myId;S.myPubKey=s.myPubKey;
  S.adminPubKey=s.adminPubKey;S.isAdmin=s.isAdmin;S.nick=s.nick;
  showHome();alert('Session restored. Join with a new code to reconnect.');
}
function storeMessage(m){
  const k='msg_'+S.roomId;const arr=Store.get(k)||[];
  arr.push({...m,ts:m.ts||Date.now()});
  Store.set(k,arr.filter(x=>x.ts>Date.now()-S.msgTTL));
}
function loadStoredMessages(){
  const arr=Store.get('msg_'+S.roomId)||[];const cut=Date.now()-S.msgTTL;
  arr.filter(m=>m.ts>cut).forEach(m=>addMsg(m.nick,m.text,m.self,m.ts));
}
function leaveRoom(){if(S.dc)S.dc.close();if(S.pc)S.pc.close();S.dc=null;S.pc=null;Store.del('session');showHome()}

// ============== UTIL ==============
function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}

// ============== INIT ==============
(function(){
  const h=location.hash.slice(1);if(!h){showHome();return}
  if(h.startsWith('A=')){showHome();setTimeout(()=>{doCreate().then(()=>{$('ans-in').value=decodeURIComponent(h.slice(2))})},100);return}
  const code=decodeURIComponent(h);
  if(code.startsWith('G:')){showJoin(code);return}
  showHome();
})();
</script>
</body>
</html>
